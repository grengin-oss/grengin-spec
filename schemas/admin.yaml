# Admin domain schemas - Organization, API Keys, Rate Limits, Budgets

# Full AI Model with admin-specific fields (references ModelInfo from common.yaml)
AIModel:
  type: object
  required:
    - id
    - model_name
    - display_name
    - engine
  properties:
    id:
      type: string
      format: uuid
    model_name:
      type: string
      description: Model identifier used with APIs (e.g., gpt-4.1, claude-sonnet-4-20250514)
    display_name:
      type: string
      description: Human-readable name for the model
    engine:
      $ref: 'common.yaml#/AIEngine'
    parameters:
      type: array
      items:
        $ref: 'common.yaml#/AIModelParameter'
      description: Configurable parameters for the model
    comment:
      type:
        - string
        - "null"
      description: Comment displayed to user when model is selected
    icon:
      type:
        - string
        - "null"
      description: Optional SVG icon (overrides engine default icon)
    is_active:
      type: boolean
      default: true
      description: Whether the model is available for use
    supports_vision:
      type: boolean
      default: false
      description: Whether the model supports image inputs
    supports_pdf_native:
      type: boolean
      default: false
      description: Whether the model supports native PDF processing
    supports_web_search:
      type: boolean
      default: false
      description: Whether the model supports web search
    max_images:
      type:
        - integer
        - "null"
      description: Maximum number of images supported per request
    is_default:
      type: boolean
      description: Default model for this engine
      default: false
    created_at:
      type: string
      format: date-time
    updated_at:
      type: string
      format: date-time
  example:
    id: 550e8400-e29b-41d4-a716-446655440000
    model_name: claude-sonnet-4-20250514
    display_name: Claude Sonnet 4
    engine: anthropic
    is_active: true
    is_default: false
    supports_vision: true
    supports_pdf_native: true
    supports_web_search: false
    max_images: 20

AIModelCreate:
  type: object
  required:
    - model_name
    - display_name
    - engine
  properties:
    model_name:
      type: string
    display_name:
      type: string
    engine:
      $ref: 'common.yaml#/AIEngine'
    parameters:
      type: array
      items:
        $ref: 'common.yaml#/AIModelParameter'
    comment:
      type: string
    icon:
      type: string
    is_active:
      type: boolean
      default: true
    supports_vision:
      type: boolean
      default: false
    supports_pdf_native:
      type: boolean
      default: false
    supports_web_search:
      type: boolean
      default: false
    max_images:
      type: integer

AIModelUpdate:
  type: object
  properties:
    model_name:
      type: string
    display_name:
      type: string
    engine:
      $ref: 'common.yaml#/AIEngine'
    parameters:
      type: array
      items:
        $ref: 'common.yaml#/AIModelParameter'
    comment:
      type: string
    icon:
      type: string
    is_active:
      type: boolean
    supports_vision:
      type: boolean
    supports_pdf_native:
      type: boolean
    supports_web_search:
      type: boolean
    max_images:
      type: integer

# AI Engine - consolidated resource for engine config, API key, and model whitelist
AIEngineDetail:
  type: object
  required:
    - engine_key
    - display_name
    - is_enabled
    - api_key_configured
  properties:
    engine_key:
      type: string
      description: Unique identifier for the engine (e.g., 'openai', 'anthropic', 'groq')
    display_name:
      type: string
      description: Human-readable name for the engine
    icon:
      type: string
      description: SVG icon for the engine
    is_enabled:
      type: boolean
      description: Whether this engine is enabled for the organization
    api_key_configured:
      type: boolean
      description: Whether an API key has been set for this engine
    api_key_status:
      type: string
      enum:
        - valid
        - invalid
        - untested
      description: Status of the configured API key
    api_key_preview:
      type:
        - string
        - "null"
      description: Last 4 characters of the configured API key
    api_key_last_validated_at:
      type:
        - string
        - "null"
      format: date-time
      description: When the API key was last validated
    whitelisted_models:
      type: array
      items:
        type: string
      description: |
        Global whitelist of model_name values allowed for this engine.
        Empty array means all models from this engine are allowed.
    default_model:
      type:
        - string
        - "null"
      description: Default model for this engine
    is_default:
      type: boolean
      description: Organization's default engine
      default: false
    updated_at:
      type:
        - string
        - "null"
      format: date-time
  example:
    engine_key: openai
    display_name: OpenAI
    is_default: false
    icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">...</svg>'
    is_enabled: true
    api_key_configured: true
    api_key_status: valid
    api_key_preview: "sk-...abc1"
    api_key_last_validated_at: "2025-01-15T10:30:00Z"
    whitelisted_models:
      - gpt-4.1
      - gpt-4.1-mini
      - o3
    default_model: gpt-4.1

AIEngineUpdate:
  type: object
  description: Request body for updating an AI engine configuration
  properties:
    is_enabled:
      type: boolean
      description: Enable or disable this engine
    api_key:
      type: string
      description: The API key (write-only, for setting or rotating)
    whitelisted_models:
      type: array
      items:
        type: string
      description: Models to whitelist for this engine
    default_model:
      type: string
      description: Default model for this engine

AIEngineValidateResponse:
  type: object
  required:
    - valid
  properties:
    valid:
      type: boolean
    message:
      type: string
    models_available:
      type: integer
      description: Number of models available with this API key
  example:
    valid: true
    message: API key validated successfully
    models_available: 15

AIEngineModelsResponse:
  type: object
  required:
    - models
  properties:
    models:
      type: array
      items:
        type: object
        properties:
          model_id:
            type: string
            description: Model identifier from the provider
          display_name:
            type: string
          is_whitelisted:
            type: boolean
            description: Whether this model is in the whitelist
          capabilities:
            type: object
            properties:
              vision:
                type: boolean
              function_calling:
                type: boolean
              streaming:
                type: boolean
  example:
    models:
      - model_id: gpt-4.1
        display_name: GPT-4.1
        is_whitelisted: true
        capabilities:
          vision: true
          function_calling: true
          streaming: true

# User-level Model Access Control
UserModelAccess:
  type: object
  required:
    - user_id
  properties:
    user_id:
      type: string
      format: uuid
    whitelisted_models:
      type: array
      items:
        type: string
      description: |
        Models this user CAN access (in addition to global whitelist).
        Only applies to models that exist in the global whitelist.
    blacklisted_models:
      type: array
      items:
        type: string
      description: |
        Models this user CANNOT access (overrides global whitelist).
        Takes precedence over user whitelist.
  example:
    user_id: 550e8400-e29b-41d4-a716-446655440001
    whitelisted_models:
      - claude-opus-4-20250514
    blacklisted_models:
      - o3

UserModelAccessUpdate:
  type: object
  properties:
    whitelisted_models:
      type: array
      items:
        type: string
    blacklisted_models:
      type: array
      items:
        type: string

# Rate Limits
RateLimitScope:
  type: string
  enum:
    - user
    - department
    - organization

RateLimitConfig:
  type: object
  required:
    - id
    - scope
    - requests_per_minute
  properties:
    id:
      type: string
      format: uuid
    scope:
      $ref: '#/RateLimitScope'
    scope_id:
      type:
        - string
        - "null"
      description: User ID, department name, or org ID depending on scope
    requests_per_minute:
      type: integer
      minimum: 1
    requests_per_hour:
      type: integer
      minimum: 1
    requests_per_day:
      type: integer
      minimum: 1
    tokens_per_day:
      type:
        - integer
        - "null"
      minimum: 1
    is_active:
      type: boolean
      default: true
    created_at:
      type: string
      format: date-time
    updated_at:
      type: string
      format: date-time

RateLimitConfigCreate:
  type: object
  required:
    - scope
    - requests_per_minute
  properties:
    scope:
      $ref: '#/RateLimitScope'
    scope_id:
      type:
        - string
        - "null"
    requests_per_minute:
      type: integer
      minimum: 1
    requests_per_hour:
      type: integer
      minimum: 1
    requests_per_day:
      type: integer
      minimum: 1
    tokens_per_day:
      type:
        - integer
        - "null"
      minimum: 1

RateLimitStatus:
  type: object
  properties:
    requests_remaining:
      type: integer
    requests_limit:
      type: integer
    tokens_remaining:
      type:
        - integer
        - "null"
    tokens_limit:
      type:
        - integer
        - "null"
    reset_at:
      type: string
      format: date-time

# Budgets
BudgetPeriod:
  type: string
  enum:
    - daily
    - weekly
    - monthly

Budget:
  type: object
  required:
    - id
    - scope
    - limit_amount
    - period
  properties:
    id:
      type: string
      format: uuid
    scope:
      $ref: '#/RateLimitScope'
    scope_id:
      type:
        - string
        - "null"
    limit_amount:
      type: number
      format: float
      description: Budget limit in USD
    period:
      $ref: '#/BudgetPeriod'
    current_spend:
      type: number
      format: float
      description: Current spend in the period
    alert_thresholds:
      type: array
      items:
        type: integer
      description: Percentage thresholds for alerts (e.g., [50, 75, 90, 100])
      default:
        - 50
        - 75
        - 90
        - 100
    action_on_exceed:
      type: string
      enum:
        - warn
        - throttle
        - block
      default: warn
    is_active:
      type: boolean
      default: true
    period_start:
      type: string
      format: date-time
    period_end:
      type: string
      format: date-time
    created_at:
      type: string
      format: date-time
    updated_at:
      type: string
      format: date-time

BudgetCreate:
  type: object
  required:
    - scope
    - limit_amount
    - period
  properties:
    scope:
      $ref: '#/RateLimitScope'
    scope_id:
      type:
        - string
        - "null"
    limit_amount:
      type: number
      format: float
    period:
      $ref: '#/BudgetPeriod'
    alert_thresholds:
      type: array
      items:
        type: integer
    action_on_exceed:
      type: string
      enum:
        - warn
        - throttle
        - block

BudgetStatus:
  type: object
  properties:
    budget_id:
      type: string
      format: uuid
    limit_amount:
      type: number
      format: float
    current_spend:
      type: number
      format: float
    percentage_used:
      type: number
      format: float
    remaining:
      type: number
      format: float
    period_end:
      type: string
      format: date-time
    status:
      type: string
      enum:
        - ok
        - warning
        - exceeded

# Department schemas
Department:
  type: object
  required:
    - id
    - name
    - depth
    - member_count
    - child_count
  properties:
    id:
      type: string
      format: uuid
    name:
      type: string
      maxLength: 100
    description:
      type:
        - string
        - "null"
      maxLength: 500
    parent_id:
      type:
        - string
        - "null"
      format: uuid
      description: Null for root-level departments
    path:
      type: string
      readOnly: true
      description: Materialized path (e.g., "/sales/apac/india")
    depth:
      type: integer
      readOnly: true
      description: Depth in hierarchy (0 = root)
    leader_ids:
      type: array
      items:
        type: string
        format: uuid
      description: Users who can manage this department
    member_count:
      type: integer
      readOnly: true
      description: Direct members in this department
    total_member_count:
      type: integer
      readOnly: true
      description: All members including sub-departments
    child_count:
      type: integer
      readOnly: true
      description: Direct child departments
    budget_allocated:
      type:
        - number
        - "null"
      format: float
      description: Budget allocated (USD)
    budget_distributed:
      type: number
      format: float
      readOnly: true
      description: Budget allocated to sub-departments
    budget_available:
      type: number
      format: float
      readOnly: true
      description: budget_allocated - budget_distributed
    budget_used:
      type: number
      format: float
      readOnly: true
      description: Actual spend by this department
    budget_period:
      $ref: '#/BudgetPeriod'
    created_at:
      type: string
      format: date-time
    updated_at:
      type: string
      format: date-time

DepartmentCreate:
  type: object
  required:
    - name
  properties:
    name:
      type: string
      maxLength: 100
    description:
      type: string
      maxLength: 500
    parent_id:
      type:
        - string
        - "null"
      format: uuid
    leader_ids:
      type: array
      items:
        type: string
        format: uuid

DepartmentUpdate:
  type: object
  properties:
    name:
      type: string
      maxLength: 100
    description:
      type: string
      maxLength: 500
    leader_ids:
      type: array
      items:
        type: string
        format: uuid

DepartmentTree:
  allOf:
    - $ref: '#/Department'
    - type: object
      properties:
        children:
          type: array
          items:
            $ref: '#/DepartmentTree'

DepartmentBudgetAllocation:
  type: object
  required:
    - budget_allocated
  properties:
    budget_allocated:
      type: number
      format: float
      minimum: 0
    budget_period:
      $ref: '#/BudgetPeriod'
      default: monthly
    action_on_exceed:
      type: string
      enum: [warn, throttle, block]
      default: warn

DepartmentBudgetStatus:
  type: object
  properties:
    department_id:
      type: string
      format: uuid
    budget_allocated:
      type: number
      format: float
    budget_distributed:
      type: number
      format: float
    budget_available:
      type: number
      format: float
    budget_used:
      type: number
      format: float
    budget_used_total:
      type: number
      format: float
      description: Including sub-departments
    period:
      $ref: '#/BudgetPeriod'
    period_start:
      type: string
      format: date-time
    period_end:
      type: string
      format: date-time
    sub_department_budgets:
      type: array
      items:
        type: object
        properties:
          department_id:
            type: string
            format: uuid
          name:
            type: string
          allocated:
            type: number
            format: float
          used:
            type: number
            format: float

DepartmentMove:
  type: object
  required:
    - new_parent_id
  properties:
    new_parent_id:
      type:
        - string
        - "null"
      format: uuid
      description: New parent ID (null for root)

DepartmentMembersRequest:
  type: object
  required:
    - user_ids
  properties:
    user_ids:
      type: array
      items:
        type: string
        format: uuid
      minItems: 1

# Admin Dashboard
AdminDashboard:
  type: object
  properties:
    users:
      type: object
      properties:
        total:
          type: integer
        active:
          type: integer
        new_this_month:
          type: integer
    usage:
      $ref: 'analytics.yaml#/UsageStats'
    costs:
      $ref: 'analytics.yaml#/CostSummary'
    cost_trend:
      type: array
      items:
        $ref: 'analytics.yaml#/CostTrend'
    system_health:
      $ref: 'common.yaml#/HealthResponse'
