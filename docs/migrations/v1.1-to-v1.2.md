# Migration Guide: v1.1.x to v1.2.0

This guide covers the breaking changes and new features introduced in v1.2.0.

## Overview

v1.2.0 introduces a full hierarchical departments API with CRUD operations, tree structure, budget allocation, and member management. This is a **breaking change** for implementations using the previous simple departments endpoint.

## Breaking Changes

### User Schema Changes

The `User` schema has been updated to use UUID-based department references:

| Before (v1.1) | After (v1.2) |
|---------------|--------------|
| `department: string` | `department_id: string (uuid)` |
| â€” | `department_name: string (readOnly)` |

**Migration Steps:**

1. Update user creation/update requests to use `department_id` (UUID) instead of `department` (string name)
2. Update UI to display `department_name` (populated by server) for read operations
3. Use the new departments API to get valid department IDs

### Departments Endpoint Changes

The `GET /admin/departments` response schema has changed:

```yaml
# Before (v1.1)
departments:
  - name: "Engineering"
    user_count: 42

# After (v1.2)
departments:
  - id: "550e8400-e29b-41d4-a716-446655440000"
    name: "Engineering"
    description: "Product engineering team"
    parent_id: null
    path: "/engineering"
    depth: 0
    member_count: 42
    child_count: 3
    # ... additional fields
total: 1
```

## New Endpoints

### Department CRUD

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/admin/departments` | GET | List departments (with filtering) |
| `/admin/departments` | POST | Create department |
| `/admin/departments/{id}` | GET | Get department details |
| `/admin/departments/{id}` | PUT | Update department |
| `/admin/departments/{id}` | DELETE | Delete department |

### Department Hierarchy

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/admin/departments/tree` | GET | Get nested hierarchy tree |
| `/admin/departments/{id}/move` | POST | Move department to new parent |

### Department Budget

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/admin/departments/{id}/budget` | GET | Get budget status |
| `/admin/departments/{id}/budget` | PUT | Set budget allocation |

### Department Members

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/admin/departments/{id}/members` | GET | List department members |
| `/admin/departments/{id}/members` | POST | Add members to department |
| `/admin/departments/{id}/members` | DELETE | Remove members from department |

## New Schemas

### Department

Full department model with hierarchy and budget tracking:

```yaml
Department:
  id: string (uuid)
  name: string (max 100)
  description: string | null (max 500)
  parent_id: string (uuid) | null
  path: string (readOnly) # e.g., "/sales/apac/india"
  depth: integer (readOnly) # 0 = root
  leader_ids: string[] (uuid)
  member_count: integer (readOnly)
  total_member_count: integer (readOnly)
  child_count: integer (readOnly)
  budget_allocated: number | null
  budget_distributed: number (readOnly)
  budget_available: number (readOnly)
  budget_used: number (readOnly)
  budget_period: BudgetPeriod
  created_at: datetime
  updated_at: datetime
```

### Supporting Schemas

- `DepartmentCreate` - Request body for creating departments
- `DepartmentUpdate` - Request body for updating departments
- `DepartmentTree` - Recursive structure for hierarchy representation
- `DepartmentBudgetAllocation` - Request body for budget allocation
- `DepartmentBudgetStatus` - Budget status with sub-department breakdown
- `DepartmentMove` - Request body for moving departments
- `DepartmentMembersRequest` - Request body for adding/removing members

## Query Parameters

### List Departments

- `parent_id` - Filter by parent (use 'root' for top-level only)
- `include_children` - Include child departments in response

### Department Tree

- `root_id` - Start from specific department (default: entire org)
- `max_depth` - Maximum depth to traverse (1-10, default: 10)

### List Members

- `include_sub_departments` - Include members from child departments

### Delete Department

- `force` - Force delete and reassign members to parent department

## Migration Steps

### 1. Database Migration

If you stored department names as strings, you'll need to:

1. Create a departments table with UUID primary keys
2. Migrate existing department names to the new table
3. Update user records to reference department UUIDs

### 2. API Client Updates

```typescript
// Before (v1.1)
const user = await api.createUser({
  email: "user@example.com",
  department: "Engineering"
});

// After (v1.2)
// First, get or create the department
const dept = await api.createDepartment({ name: "Engineering" });
const user = await api.createUser({
  email: "user@example.com",
  department_id: dept.id
});
```

### 3. UI Updates

- Replace department text inputs with department pickers
- Use `/admin/departments/tree` to populate hierarchical selectors
- Display `department_name` from user responses (server-populated)

## Budget Hierarchy

Budgets flow down the hierarchy:

1. Parent department allocates budget
2. `budget_distributed` tracks amount allocated to children
3. `budget_available` = `budget_allocated` - `budget_distributed`
4. Child allocations cannot exceed parent's `budget_available`

## Backwards Compatibility

For a transitional period, consider:

1. Accepting both `department` (string) and `department_id` (UUID) in user creation
2. Auto-creating departments for unknown department names
3. Populating both fields in user responses

This allows gradual migration of client applications.

---

## v1.2.1 Changes

### SSO Provider Editable Fields

GET `/admin/sso-providers/{id}` now returns an `editable_fields` array indicating which fields can be modified via PUT. Immutable fields (`id`, `provider`, `created_at`, `updated_at`) are marked `readOnly`.

**Schema changes:**
- Added `editable_fields` array to `OidcProviderConfig`
- Added `client_secret_configured` boolean (replaces writeOnly `client_secret`)
- New `OidcProviderConfigUpdate` schema for PUT (all fields optional)

### Chat Streaming Event Schemas

New schemas documenting the SSE event types for `POST /chat/stream`:

| Event | Schema | Description |
|-------|--------|-------------|
| `conversation` | `StreamEventConversation` | Conversation metadata (id, title, is_new) |
| `message_start` | `StreamEventMessageStart` | Assistant message beginning (message_id) |
| `delta` | `StreamEventDelta` | Text chunk (text) |
| `message_end` | `StreamEventMessageEnd` | Usage stats (input_tokens, output_tokens, latency_ms) |
| `done` | `StreamEventDone` | Stream completion marker |
