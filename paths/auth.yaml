# Authentication and authorization (SSO via OpenID Connect)

# Login
/auth/login:
  post:
    tags:
    - auth
    summary: Password login
    description: |
      Authenticate with email and password (for super admin or password-enabled accounts).
      If MFA is enabled, returns a temporary token to complete MFA verification.
    operationId: passwordLogin
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/PasswordLoginRequest'
    responses:
      '200':
        description: Login successful or MFA required
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/PasswordLoginResponse'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'
      '423':
        description: Account locked (too many failed attempts)
        content:
          application/json:
            schema:
              type: object
              properties:
                detail:
                  type: string
                locked_until:
                  type: string
                  format: date-time

/auth/{provider}:
  get:
    tags:
    - auth
    summary: Initiate SSO login
    description: Start the OAuth/OIDC flow for the specified provider
    operationId: initiateAuth
    security: []
    parameters:
    - $ref: '../openapi.yaml#/components/parameters/AuthProvider'
    - name: redirect_uri
      in: query
      description: Optional redirect URI after successful authentication
      schema:
        type: string
        format: uri
    responses:
      '200':
        description: Authentication URL and state
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/AuthInitResponse'
      '302':
        description: Redirect to provider's login page
      '400':
        description: Invalid provider or configuration
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/Error'

/auth/{provider}/callback:
  get:
    tags:
    - auth
    summary: OAuth callback (GET)
    description: |
      Handle the OAuth callback from the identity provider via query parameters.
      Used when the OAuth provider redirects directly to this endpoint.
    operationId: authCallbackGet
    security: []
    parameters:
    - $ref: '../openapi.yaml#/components/parameters/AuthProvider'
    - name: code
      in: query
      required: true
      schema:
        type: string
    - name: state
      in: query
      required: true
      schema:
        type: string
    - name: error
      in: query
      schema:
        type: string
    - name: error_description
      in: query
      schema:
        type: string
    responses:
      '200':
        description: Authentication successful
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/AuthTokenResponse'
      '302':
        description: Redirect to application with tokens
      '400':
        description: Invalid callback parameters
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/Error'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'
  post:
    tags:
    - auth
    summary: OAuth callback (POST)
    description: |
      Handle the OAuth callback via POST request body.
      Preferred for providers with long authorization codes (e.g., Azure AD)
      to avoid URL length limits.
    operationId: authCallbackPost
    security: []
    parameters:
    - $ref: '../openapi.yaml#/components/parameters/AuthProvider'
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/AuthCallbackRequest'
    responses:
      '200':
        description: Authentication successful
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/AuthTokenResponse'
      '400':
        description: Invalid callback parameters
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/Error'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'

# MFA
/auth/mfa/setup:
  post:
    tags:
    - auth
    summary: Set up MFA
    description: Initialize TOTP-based MFA for the current user. Returns QR code and secret.
    operationId: setupMfa
    security:
    - bearerAuth: []
    responses:
      '200':
        description: MFA setup information
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/MfaSetupResponse'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'
      '409':
        $ref: '../openapi.yaml#/components/responses/Conflict'

/auth/mfa/verify:
  post:
    tags:
    - auth
    summary: Verify MFA code
    description: Verify a TOTP code for MFA setup or login completion
    operationId: verifyMfa
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/MfaVerifyRequest'
    responses:
      '200':
        description: MFA verified successfully
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/AuthTokenResponse'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'

/auth/mfa/recovery:
  post:
    tags:
    - auth
    summary: Use recovery code
    description: Use a recovery code to bypass MFA (single-use, code is consumed)
    operationId: useMfaRecovery
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/MfaRecoveryRequest'
    responses:
      '200':
        description: Recovery successful
        content:
          application/json:
            schema:
              type: object
              properties:
                access_token:
                  type: string
                refresh_token:
                  type: string
                remaining_codes:
                  type: integer
                user:
                  $ref: '../openapi.yaml#/components/schemas/User'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'

/auth/mfa/regenerate-codes:
  post:
    tags:
    - auth
    summary: Regenerate recovery codes
    description: Generate new recovery codes (invalidates existing ones)
    operationId: regenerateMfaCodes
    security:
    - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - current_password
            properties:
              current_password:
                type: string
    responses:
      '200':
        description: New recovery codes
        content:
          application/json:
            schema:
              type: object
              properties:
                recovery_codes:
                  type: array
                  items:
                    type: string
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'

# Password management
/auth/password/forgot:
  post:
    tags:
    - auth
    summary: Request password reset
    description: Send a password reset email to the user
    operationId: forgotPassword
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/PasswordForgotRequest'
    responses:
      '200':
        description: Reset email sent (always returns success for security)
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string

/auth/password/reset:
  post:
    tags:
    - auth
    summary: Reset password
    description: Reset password using token from email
    operationId: resetPassword
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/PasswordResetRequest'
    responses:
      '200':
        description: Password reset successful
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
      '400':
        description: Invalid or expired token, or weak password
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/Error'

/auth/password/change:
  post:
    tags:
    - auth
    summary: Change password
    description: Change password for logged-in user
    operationId: changePassword
    security:
    - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/PasswordChangeRequest'
    responses:
      '200':
        description: Password changed successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
      '400':
        description: Invalid current password or weak new password
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/Error'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'

# Token management
/auth/refresh:
  post:
    tags:
    - auth
    summary: Refresh access token
    description: Exchange a refresh token for a new access token
    operationId: refreshToken
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../openapi.yaml#/components/schemas/RefreshTokenRequest'
    responses:
      '200':
        description: New tokens
        content:
          application/json:
            schema:
              $ref: '../openapi.yaml#/components/schemas/AuthTokenResponse'
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'

/auth/logout:
  post:
    tags:
    - auth
    summary: Logout
    description: Invalidate the current session and tokens
    operationId: logout
    security:
    - bearerAuth: []
    responses:
      '204':
        description: Successfully logged out
      '401':
        $ref: '../openapi.yaml#/components/responses/Unauthorized'
